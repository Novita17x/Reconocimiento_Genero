<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minijuego de Reconocimiento de Voz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Pantalla de Inicio */
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: gradientShift 5s ease-in-out infinite alternate;
        }

        @keyframes gradientShift {
            0% { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
            100% { background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%); }
        }

        .title {
            font-size: 4rem;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 3s ease-in-out infinite;
        }

        @keyframes rainbow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 3rem;
            text-align: center;
            opacity: 0.9;
        }

        .team-info {
            background: rgba(255,255,255,0.1);
            padding: 2rem;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 3rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .team-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #ffd700;
        }

        .team-members {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .start-button {
            padding: 15px 40px;
            font-size: 1.3rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.4);
            background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
        }

        /* Juego Principal */
        .game-container {
            width: 100%;
            height: 100vh;
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
        }

        .game-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="2" cy="2" r="1" fill="white" opacity="0.3"/><circle cx="12" cy="8" r="0.5" fill="white" opacity="0.5"/><circle cx="18" cy="15" r="0.8" fill="white" opacity="0.4"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>');
            animation: twinkle 8s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }

        .character-container {
            position: absolute;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .character {
            width: 150px;
            height: 200px;
            margin: 0 auto 20px;
            position: relative;
            transition: all 0.5s ease;
            background: linear-gradient(180deg, #6c757d 0%, #495057 50%, #343a40 100%);
            border-radius: 50px 50px 20px 20px;
        }

        .character.male {
            background: linear-gradient(180deg, #8B4513 0%, #654321 50%, #2F4F4F 100%);
            border-radius: 50px 50px 20px 20px;
        }

        .character.female {
            background: linear-gradient(180deg, #FFB6C1 0%, #FF69B4 50%, #8A2BE2 100%);
            border-radius: 50px 50px 30px 30px;
        }

        .character::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background: #FDBCB4;
            border-radius: 50%;
            border: 3px solid #333;
        }

        .character::after {
            content: '😊';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
        }

        .character.speaking {
            animation: bounce 0.5s ease-in-out infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }

        .speech-bubble {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 1.1rem;
            min-width: 200px;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid white;
        }

        .speech-bubble.show {
            opacity: 1;
            top: -100px;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            background: rgba(0,0,0,0.5);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .voice-analysis {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .frequency-display {
            font-size: 1.2rem;
            color: #4ecdc4;
            margin-bottom: 10px;
        }

        .gender-indicator {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 25px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .gender-indicator.male {
            background: linear-gradient(45deg, #4A90E2, #7B68EE);
            color: white;
        }

        .gender-indicator.female {
            background: linear-gradient(45deg, #FF69B4, #FF1493);
            color: white;
        }

        .gender-indicator.analyzing {
            background: linear-gradient(45deg, #FFA500, #FF6347);
            color: white;
            animation: pulse 1s infinite;
        }

        .record-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: linear-gradient(45deg, #ff4757, #ff6b6b);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            position: relative;
        }

        .record-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,71,87,0.4);
        }

        .record-btn.recording {
            background: linear-gradient(45deg, #ff3838, #ff5757);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .status {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #4ecdc4;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* Efectos de sonido visuales */
        .sound-waves {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sound-waves.active {
            opacity: 1;
        }

        .wave {
            width: 300px;
            height: 300px;
            border: 2px solid rgba(78, 205, 196, 0.3);
            border-radius: 50%;
            position: absolute;
            animation: ripple 2s infinite;
        }

        .wave:nth-child(2) {
            animation-delay: 0.5s;
        }

        .wave:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* Visualizador de frecuencia */
        .frequency-visualizer {
            width: 200px;
            height: 50px;
            background: rgba(0,0,0,0.3);
            border-radius: 25px;
            margin: 10px auto;
            position: relative;
            overflow: hidden;
        }

        .frequency-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            border-radius: 25px;
            transition: width 0.1s ease;
            width: 0%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title {
                font-size: 2.5rem;
            }
            
            .character {
                width: 120px;
                height: 160px;
            }
            
            .controls {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Inicio -->
    <div class="start-screen" id="startScreen">
        <h1 class="title">🎙️ ECHO VOICE</h1>
        <p class="subtitle">Minijuego de Reconocimiento Automático de Voz por Frecuencia</p>
        
        <div class="team-info">
            <h3 class="team-title">👥 Equipo de Desarrollo</h3>
            <div class="team-members">
                <p><strong>Desarrolladores:</strong></p>
                <p>• [Tu Nombre Aquí] - Programación Principal</p>
                <p>• [Nombre del Compañero 1] - Análisis de Audio</p>
                <p>• [Nombre del Compañero 2] - Diseño UI/UX</p>
                <p>• [Nombre del Compañero 3] - Testing y Documentación</p>
            </div>
        </div>
        
        <button class="start-button" onclick="startGame()">
            🎮 COMENZAR JUEGO
        </button>
    </div>

    <!-- Juego Principal -->
    <div class="game-container" id="gameContainer">
        <div class="game-bg"></div>
        
        <button class="back-btn" onclick="goHome()">🏠 Volver</button>
        
        <div class="controls">
            <div class="voice-analysis">
                <h3>🎵 Análisis de Voz Automático</h3>
                <div class="frequency-display" id="frequencyDisplay">
                    Frecuencia: -- Hz
                </div>
                <div class="frequency-visualizer">
                    <div class="frequency-bar" id="frequencyBar"></div>
                </div>
                <div class="gender-indicator analyzing" id="genderIndicator">
                    🔍 Analizando voz...
                </div>
            </div>
            
            <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
                🎤 Presiona para Hablar
            </button>
            
            <div class="status" id="status">El juego detectará automáticamente tu voz</div>
        </div>

        <div class="character-container">
            <div class="character" id="character">
                <div class="speech-bubble" id="speechBubble"></div>
            </div>
        </div>

        <div class="sound-waves" id="soundWaves">
            <div class="wave"></div>
            <div class="wave"></div>
            <div class="wave"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let recognition;
        let synthesis;
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let isRecording = false;
        let detectedGender = 'analyzing';
        let voices = [];
        let frequencyData = [];
        let animationId;

        // Inicialización
        window.onload = function() {
            initSpeechRecognition();
            initSpeechSynthesis();
            initAudioAnalysis();
        };

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
        }

        function goHome() {
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            stopRecording();
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'es-ES';

                recognition.onstart = function() {
                    updateStatus('🎤 Escuchando y analizando tu voz...');
                    document.getElementById('soundWaves').classList.add('active');
                };

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    updateStatus('✅ Texto reconocido: "' + transcript + '"');
                    showSpeechBubble(transcript);
                    
                    // Esperar un momento para completar el análisis de frecuencia
                    setTimeout(() => {
                        speakText(transcript);
                    }, 500);
                };

                recognition.onerror = function(event) {
                    updateStatus('❌ Error: ' + event.error);
                    stopRecording();
                };

                recognition.onend = function() {
                    stopRecording();
                };
            } else {
                updateStatus('❌ Tu navegador no soporta reconocimiento de voz');
            }
        }

        function initSpeechSynthesis() {
            synthesis = window.speechSynthesis;
            
            synthesis.onvoiceschanged = function() {
                voices = synthesis.getVoices();
            };
            
            voices = synthesis.getVoices();
        }

        async function initAudioAnalysis() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
            } catch (error) {
                console.error('Error inicializando análisis de audio:', error);
                updateStatus('⚠️ Análisis de audio no disponible');
            }
        }

        async function startAudioAnalysis() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                frequencyData = [];
                analyzeFrequency();
                
            } catch (error) {
                console.error('Error accediendo al micrófono:', error);
                updateStatus('❌ No se puede acceder al micrófono');
            }
        }

        function analyzeFrequency() {
            if (!isRecording || !analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // Calcular frecuencia fundamental
            const fundamentalFreq = calculateFundamentalFrequency();
            
            if (fundamentalFreq > 0) {
                frequencyData.push(fundamentalFreq);
                updateFrequencyDisplay(fundamentalFreq);
                
                // Determinar género basado en frecuencia
                if (frequencyData.length > 10) { // Esperar suficientes muestras
                    const avgFreq = frequencyData.reduce((a, b) => a + b, 0) / frequencyData.length;
                    determineGender(avgFreq);
                }
            }
            
            animationId = requestAnimationFrame(analyzeFrequency);
        }

     function calculateFundamentalFrequency() {
        if (!analyser) return 0;
        
        analyser.getByteFrequencyData(dataArray);

        // UMBRAL DE ENERGÍA: Ignoramos cualquier frecuencia que no tenga
        // suficiente volumen para ser considerada una voz.
        // Puedes ajustar este valor entre 120 y 160.
        const THRESHOLD = 140; 

        // RANGO DE BÚSQUEDA: Desde una voz masculina muy grave (80Hz)
        // hasta el límite de una voz femenina (400Hz).
        const startIndex = Math.floor(80 * dataArray.length / (audioContext.sampleRate / 2));
        const endIndex = Math.floor(400 * dataArray.length / (audioContext.sampleRate / 2));

        // BÚSQUEDA ASCENDENTE: Iteramos desde la frecuencia más baja hacia la más alta.
        for (let i = startIndex; i < endIndex; i++) {
            // ¿Este pico de frecuencia es lo suficientemente fuerte para ser la voz?
            if (dataArray[i] > THRESHOLD) {
                // ¡SÍ! Como estamos buscando de abajo hacia arriba, este es
                // muy probablemente el tono fundamental.
                const frequency = i * audioContext.sampleRate / (2 * dataArray.length);
                
                // Lo devolvemos y dejamos de buscar.
                return frequency;
            }
        }
        
        // Si el bucle termina, no se encontró ninguna frecuencia lo suficientemente fuerte.
        return 0;
     }

        function updateFrequencyDisplay(frequency) {
            document.getElementById('frequencyDisplay').textContent = 
                `Frecuencia: ${Math.round(frequency)} Hz`;
            
            // Actualizar barra visual (rango aproximado 80-300 Hz)
            const percentage = Math.min(100, Math.max(0, (frequency - 80) / 220 * 100));
            document.getElementById('frequencyBar').style.width = percentage + '%';
        }

        function determineGender(avgFrequency) {
            // Rangos aproximados:
            // Hombres: 85-180 Hz (promedio ~125 Hz)
            // Mujeres: 165-265 Hz (promedio ~210 Hz)
            
            let newGender;
            if (avgFrequency < 120) {
                newGender = 'male';
            } else if (avgFrequency > 160) {
                newGender = 'female';
            } else {
                // Zona ambigua, mantener análisis
                return;
            }
            
            if (newGender !== detectedGender) {
                detectedGender = newGender;
                updateGenderDisplay();
                updateCharacter();
                
                const genderText = detectedGender === 'male' ? 'Masculina' : 'Femenina';
                updateStatus(`🎯 Voz ${genderText} detectada (${Math.round(avgFrequency)} Hz)`);
            }
        }

        function updateGenderDisplay() {
            const indicator = document.getElementById('genderIndicator');
            indicator.className = 'gender-indicator ' + detectedGender;
            
            switch(detectedGender) {
                case 'male':
                    indicator.textContent = '👨 Voz Masculina Detectada';
                    break;
                case 'female':
                    indicator.textContent = '👩 Voz Femenina Detectada';
                    break;
                default:
                    indicator.textContent = '🔍 Analizando voz...';
            }
        }

        function updateCharacter() {
            const character = document.getElementById('character');
            character.className = 'character ' + (detectedGender === 'analyzing' ? '' : detectedGender);
        }

        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            if (!recognition) {
                updateStatus('❌ Reconocimiento de voz no disponible');
                return;
            }

            isRecording = true;
            frequencyData = [];
            detectedGender = 'analyzing';
            updateGenderDisplay();
            updateCharacter();
            
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.classList.add('recording');
            recordBtn.textContent = '🛑 Detener Grabación';
            
            // Iniciar análisis de audio
            await startAudioAnalysis();
            
            // Iniciar reconocimiento de voz
            recognition.start();
        }

        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            
            isRecording = false;
            
            // Detener análisis de audio
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.classList.remove('recording');
            recordBtn.textContent = '🎤 Presiona para Hablar';
            
            document.getElementById('soundWaves').classList.remove('active');
            document.getElementById('character').classList.remove('speaking');
        }

     function speakText(text) {
         if (!synthesis) return;

         synthesis.cancel();

         const utterance = new SpeechSynthesisUtterance(text);
         utterance.lang = 'es-ES'; // Asegurar el idioma
         utterance.volume = 1;

         // CAMBIO CLAVE: Primero intentamos encontrar la voz ideal
         const voice = findBestVoice();
         
         if (voice) {
             // Plan A (Ideal): Se encontró una voz nativa masculina o femenina. Usémosla.
             // El pitch lo dará la propia voz, no necesitamos forzarlo.
             utterance.voice = voice;
             utterance.rate = 0.9; // Ajustar velocidad si se desea
         } else {
             // Plan B (Fallback): No se encontró una voz específica.
             // Usamos la voz por defecto del navegador y modificamos su PITCH.
             console.warn("No se encontró una voz específica. Usando fallback de pitch.");
             
             if (detectedGender === 'female') {
                 // 👇 AQUÍ ESTÁN LOS CAMBIOS
                 utterance.pitch = 1.7; // Aumentamos el tono aún más (antes era 1.5)
                 utterance.rate = 1.1;  // Una velocidad un poco más rápida para sonar más fluida
             } else if (detectedGender === 'male') {
                 utterance.pitch = 0.5;
                 utterance.rate = 0.85;
             } else {
                 utterance.pitch = 1.0; 
                 utterance.rate = 0.9;
             }
         }

         utterance.onstart = function() {
             document.getElementById('character').classList.add('speaking');
             const genderText = detectedGender === 'male' ? 'masculina' : 
                                  detectedGender === 'female' ? 'femenina' : 'neutra';
             updateStatus(`🔊 Reproduciendo con voz ${genderText}`);
         };

         utterance.onend = function() {
             document.getElementById('character').classList.remove('speaking');
             hideSpeechBubble();
             updateStatus('✅ Listo para una nueva grabación');
         };

         synthesis.speak(utterance);
     }

     function findBestVoice() {
         if (voices.length === 0) {
            console.log("Las voces aún no se han cargado.");
            return null;
         }

         // Filtramos primero por voces en español que sean locales (más fiables)
         const spanishVoices = voices.filter(voice => voice.lang.startsWith('es') && voice.localService);
        
         if (spanishVoices.length === 0) {
            console.log("No se encontraron voces locales en español, intentando con cualquiera en español.");
            // Si no hay locales, buscamos cualquiera en español.
            const allSpanishVoices = voices.filter(voice => voice.lang.startsWith('es'));
            if(allSpanishVoices.length === 0) return null; // No hay ninguna en español
         }

         let bestVoice = null;

         if (detectedGender === 'female') {
             // Búsqueda de nombres comunes para voces femeninas
             bestVoice = spanishVoices.find(voice => 
                 /female|mujer|femenina|helena|laura|paulina/i.test(voice.name)
             );
         } else if (detectedGender === 'male') {
             // Búsqueda de nombres comunes para voces masculinas
             bestVoice = spanishVoices.find(voice => 
                 /male|hombre|masculina|jorge|diego|pablo/i.test(voice.name)
             );
         }

         // Si encontramos una voz, la devolvemos. Si no, devolvemos null.
         return bestVoice; 
     }


        function showSpeechBubble(text) {
            const bubble = document.getElementById('speechBubble');
            bubble.textContent = text;
            bubble.classList.add('show');
        }

        function hideSpeechBubble() {
            const bubble = document.getElementById('speechBubble');
            bubble.classList.remove('show');
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Solicitar permisos de micrófono al cargar
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(stream) {
                console.log('Permisos de micrófono concedidos');
                stream.getTracks().forEach(track => track.stop());
                updateStatus('🎤 Micrófono listo - El juego detectará tu voz automáticamente');
            })
            .catch(function(error) {
                console.error('Error al acceder al micrófono:', error);
                updateStatus('❌ Se necesitan permisos de micrófono para el análisis de voz');
            });
    </script>
</body>
</html>
